<!DOCTYPE html><html lang="en"><head>
      

        <title>Drive II: Combine</title>
        <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
        <meta http-equiv="content-type" content="text/html; charset=utf-8">
        <meta charset="utf-8">
        <meta name="Description" content="Drive II: Combine, Functional Reactive Programming with Combine &amp; UIKit by Scott Orlyck">
        <meta name="twitter:title" content="Drive II: Combine">
        <meta name="twitter:description" content="">
        <meta name="twitter:image" content="">
        <meta name="twitter:card" content="summary_large_image">
        <meta name="twitter:site" content="">
        <meta name="twitter:creator" content="@orlyck">
        <meta property="og:url" content="">
        <meta property="og:title" content="Drive">
        <meta property="og:description" content="">
        <meta property="og:image" content="">
        <meta property="og:image:secure" content="">
    <style type="text/css">@font-face{font-display:swap;font-family:et-book;font-style:normal;font-weight:400;src:url(/et-book/et-book-roman-line-figures/et-book-roman-line-figures.eot);src:url(/et-book/et-book-roman-line-figures/et-book-roman-line-figures.eot?#iefix) format("embedded-opentype"),url(/et-book/et-book-roman-line-figures/et-book-roman-line-figures.woff) format("woff"),url(/et-book/et-book-roman-line-figures/et-book-roman-line-figures.ttf) format("truetype"),url(/et-book/et-book-roman-line-figures/et-book-roman-line-figures.svg#etbookromanosf) format("svg")}@font-face{font-display:swap;font-family:et-book;font-style:italic;font-weight:400;src:url(/et-book/et-book-display-italic-old-style-figures/et-book-display-italic-old-style-figures.eot);src:url(/et-book/et-book-display-italic-old-style-figures/et-book-display-italic-old-style-figures.eot?#iefix) format("embedded-opentype"),url(/et-book/et-book-display-italic-old-style-figures/et-book-display-italic-old-style-figures.woff) format("woff"),url(/et-book/et-book-display-italic-old-style-figures/et-book-display-italic-old-style-figures.ttf) format("truetype"),url(/et-book/et-book-display-italic-old-style-figures/et-book-display-italic-old-style-figures.svg#etbookromanosf) format("svg")}@font-face{font-display:swap;font-family:et-book;font-style:normal;font-weight:700;src:url(/et-book/et-book-bold-line-figures/et-book-bold-line-figures.eot);src:url(/et-book/et-book-bold-line-figures/et-book-bold-line-figures.eot?#iefix) format("embedded-opentype"),url(/et-book/et-book-bold-line-figures/et-book-bold-line-figures.woff) format("woff"),url(/et-book/et-book-bold-line-figures/et-book-bold-line-figures.ttf) format("truetype"),url(/et-book/et-book-bold-line-figures/et-book-bold-line-figures.svg#etbookromanosf) format("svg")}@font-face{font-display:swap;font-family:et-book-roman-old-style;font-style:normal;font-weight:400;src:url(/et-book/et-book-roman-old-style-figures/et-book-roman-old-style-figures.eot);src:url(/et-book/et-book-roman-old-style-figures/et-book-roman-old-style-figures.eot?#iefix) format("embedded-opentype"),url(/et-book/et-book-roman-old-style-figures/et-book-roman-old-style-figures.woff) format("woff"),url(/et-book/et-book-roman-old-style-figures/et-book-roman-old-style-figures.ttf) format("truetype"),url(/et-book/et-book-roman-old-style-figures/et-book-roman-old-style-figures.svg#etbookromanosf) format("svg")}html{font-size:15px}body{background-color:#fffff8;color:#111;counter-reset:sidenote-counter;font-family:et-book,Palatino,Palatino Linotype,Palatino LT STD,Book Antiqua,Georgia,serif;margin-left:auto;margin-right:auto;max-width:1400px;padding-left:12.5%;width:87.5%}@media (prefers-color-scheme:dark){body{background-color:#151515;color:#ddd}}h1{font-size:3.2rem;font-weight:400;line-height:1;margin-bottom:1.5rem;margin-top:4rem}h2{font-size:2.2rem;margin-top:2.1rem}h2,h3{font-style:italic;font-weight:400;line-height:1;margin-bottom:1.4rem}h3{font-size:1.7rem;margin-top:2rem}hr{border:0;border-top:1px solid #ccc;display:block;height:1px;margin:1em 0;padding:0;width:55%}p.subtitle{display:block;font-size:1.8rem;font-style:italic;line-height:1;margin-bottom:1rem;margin-top:1rem}.numeral{font-family:et-book-roman-old-style}.danger{color:red}article{padding:5rem 0}section{padding-bottom:1rem;padding-top:1rem}dl,ol,p,ul{font-size:1.4rem;line-height:2rem}p{margin-bottom:1.4rem;margin-top:1.4rem;padding-right:0;vertical-align:baseline}div.epigraph{margin:5em 0}div.epigraph>blockquote{margin-bottom:3em;margin-top:3em}div.epigraph>blockquote,div.epigraph>blockquote>p{font-style:italic}div.epigraph>blockquote>footer{font-style:normal}div.epigraph>blockquote>footer>cite{font-style:italic}blockquote{font-size:1.4rem}blockquote p{margin-right:40px;width:55%}blockquote footer{font-size:1.1rem;text-align:right;width:55%}section>footer,section>p,section>table{width:55%}section>dl,section>ol,section>ul{-webkit-padding-start:5%;width:50%}dt:not(:first-child),li:not(:first-child){margin-top:.25rem}figure{-webkit-margin-start:0;-webkit-margin-end:0;border:0;font-size:100%;font:inherit;margin:0 0 3em;max-width:55%;padding:0}figcaption,figure{vertical-align:baseline}figcaption{clear:right;float:right;font-size:1.1rem;line-height:1.6;margin-bottom:0;margin-top:0;max-width:40%;position:relative}figure.fullwidth figcaption{margin-right:24%}a:link,a:visited{color:inherit}.no-tufte-underline:link{background:unset;text-shadow:unset}.hover-tufte-underline:hover,.tufte-underline,a:link{background:linear-gradient(#fffff8,#fffff8),linear-gradient(#fffff8,#fffff8),linear-gradient(currentColor,currentColor);background-position:0 93%,100% 93%,0 93%;background-repeat:no-repeat,no-repeat,repeat-x;background-size:.05em 1px,.05em 1px,1px 1px;text-decoration:none;text-shadow:.03em 0 #fffff8,-.03em 0 #fffff8,0 .03em #fffff8,0 -.03em #fffff8,.06em 0 #fffff8,-.06em 0 #fffff8,.09em 0 #fffff8,-.09em 0 #fffff8,.12em 0 #fffff8,-.12em 0 #fffff8,.15em 0 #fffff8,-.15em 0 #fffff8}@media screen and (-webkit-min-device-pixel-ratio:0){.hover-tufte-underline:hover,.tufte-underline,a:link{background-position-y:87%,87%,87%}}@media (prefers-color-scheme:dark){.hover-tufte-underline:hover,.tufte-underline,a:link{text-shadow:.03em 0 #151515,-.03em 0 #151515,0 .03em #151515,0 -.03em #151515,.06em 0 #151515,-.06em 0 #151515,.09em 0 #151515,-.09em 0 #151515,.12em 0 #151515,-.12em 0 #151515,.15em 0 #151515,-.15em 0 #151515}}a:link::-moz-selection{background:#b4d5fe;text-shadow:.03em 0 #b4d5fe,-.03em 0 #b4d5fe,0 .03em #b4d5fe,0 -.03em #b4d5fe,.06em 0 #b4d5fe,-.06em 0 #b4d5fe,.09em 0 #b4d5fe,-.09em 0 #b4d5fe,.12em 0 #b4d5fe,-.12em 0 #b4d5fe,.15em 0 #b4d5fe,-.15em 0 #b4d5fe}a:link::-moz-selection,a:link::selection{background:#b4d5fe;text-shadow:.03em 0 #b4d5fe,-.03em 0 #b4d5fe,0 .03em #b4d5fe,0 -.03em #b4d5fe,.06em 0 #b4d5fe,-.06em 0 #b4d5fe,.09em 0 #b4d5fe,-.09em 0 #b4d5fe,.12em 0 #b4d5fe,-.12em 0 #b4d5fe,.15em 0 #b4d5fe,-.15em 0 #b4d5fe}img{max-width:100%}.marginnote,.sidenote{clear:right;float:right;font-size:1.1rem;line-height:1.3;margin-bottom:0;margin-right:-60%;margin-top:.3rem;position:relative;vertical-align:baseline;width:50%}.sidenote-number{counter-increment:sidenote-counter}.sidenote-number:after,.sidenote:before{font-family:et-book-roman-old-style;position:relative;vertical-align:baseline}.sidenote-number:after{content:counter(sidenote-counter);font-size:1rem;left:.1rem;top:-.5rem}.sidenote:before{content:counter(sidenote-counter) " ";font-size:1rem;top:-.5rem}blockquote .marginnote,blockquote .sidenote{margin-right:-82%;min-width:59%;text-align:left}div.fullwidth,table.fullwidth{width:100%}div.table-wrapper{font-family:Trebuchet MS,Gill Sans,Gill Sans MT,sans-serif;overflow-x:auto}.sans{font-family:Gill Sans,Gill Sans MT,Calibri,sans-serif;letter-spacing:.03em}code,pre>code{-webkit-text-size-adjust:100%;font-family:Consolas,Liberation Mono,Menlo,Courier,monospace;font-size:1rem;line-height:1.42}.sans>code{font-size:1.2rem}h1>code,h2>code,h3>code{font-size:.8em}.marginnote>code,.sidenote>code{font-size:1rem}pre>code{display:block;font-size:.9rem;margin-left:2.5%;overflow-x:auto;width:52.5%}pre.fullwidth>code{width:90%}.fullwidth{clear:both;max-width:90%}span.newthought{-webkit-font-feature-settings:"smcp";font-feature-settings:"smcp";font-size:1.2em;font-variant:small-caps}input.margin-toggle{display:none}label.sidenote-number{display:inline-block;max-height:2rem}label.margin-toggle:not(.sidenote-number){display:none}.iframe-wrapper{height:0;padding-bottom:56.25%;padding-top:25px;position:relative}.iframe-wrapper iframe{height:100%;left:0;position:absolute;top:0;width:100%}@media (max-width:760px){body{padding-left:8%;padding-right:8%;width:84%}hr,section>footer,section>p,section>table{width:100%}pre>code{width:97%}section>dl,section>ol,section>ul{width:90%}figure{max-width:90%}figcaption,figure.fullwidth figcaption{margin-right:0;max-width:none}blockquote{margin-left:1.5em;margin-right:0}blockquote footer,blockquote p{width:100%}label.margin-toggle:not(.sidenote-number){display:inline}.marginnote,.sidenote{display:none}.margin-toggle:checked+.marginnote,.margin-toggle:checked+.sidenote{clear:both;display:block;float:left;left:1rem;margin:1rem 2.5%;position:relative;vertical-align:baseline;width:95%}label{cursor:pointer}div.table-wrapper,table{width:85%}img{width:100%}}</style><style type="text/css">pre[data-line]{padding:1em 0 1em 3em;position:relative}.line-highlight{background:hsla(24,20%,50%,.08);background:linear-gradient(90deg,hsla(24,20%,50%,.1) 70%,hsla(24,20%,50%,0));left:0;line-height:inherit;margin-top:1em;padding-bottom:inherit;padding-left:0;padding-right:0;padding-top:inherit;pointer-events:none;position:absolute;right:0;white-space:pre}@media print{.line-highlight{-webkit-print-color-adjust:exact;color-adjust:exact}}.line-highlight:before,.line-highlight[data-end]:after{background-color:hsla(24,20%,50%,.4);border-radius:999px;box-shadow:0 1px #fff;color:#f5f2f0;content:attr(data-start);font:700 65%/1.5 sans-serif;left:.6em;min-width:1em;padding:0 .5em;position:absolute;text-align:center;text-shadow:none;top:.4em;vertical-align:.3em}.line-highlight[data-end]:after{bottom:.4em;content:attr(data-end);top:auto}.line-numbers .line-highlight:after,.line-numbers .line-highlight:before{content:none}pre[id].linkable-line-numbers span.line-numbers-rows{pointer-events:all}pre[id].linkable-line-numbers span.line-numbers-rows>span:before{cursor:pointer}pre[id].linkable-line-numbers span.line-numbers-rows>span:hover:before{background-color:hsla(0,0%,50%,.2)}@media screen{code[class*=language-],pre[class*=language-]{background:#faf8f5;color:#728fcb;direction:ltr;font-family:Consolas,Menlo,Monaco,Andale Mono WT,Andale Mono,Lucida Console,Lucida Sans Typewriter,DejaVu Sans Mono,Bitstream Vera Sans Mono,Liberation Mono,Nimbus Mono L,Courier New,Courier,monospace;font-size:14px;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;line-height:1.375;-moz-tab-size:4;-o-tab-size:4;tab-size:4;text-align:left;white-space:pre;word-break:normal;word-spacing:normal}code[class*=language-]::-moz-selection,code[class*=language-] ::-moz-selection,pre[class*=language-]::-moz-selection,pre[class*=language-] ::-moz-selection{background:#faf8f5;text-shadow:none}code[class*=language-]::selection,code[class*=language-] ::selection,pre[class*=language-]::selection,pre[class*=language-] ::selection{background:#faf8f5;text-shadow:none}pre[class*=language-]{margin:.5em 0;overflow:auto;padding:1em}:not(pre)>code[class*=language-]{border-radius:.3em;padding:.1em}.token.cdata,.token.comment,.token.doctype,.token.prolog,.token.punctuation{color:#b6ad9a}.token.namespace{opacity:.7}.token.number,.token.operator,.token.tag{color:#063289}.token.function,.token.property{color:#b29762}.token.atrule-id,.token.selector,.token.tag-id{color:#2d2006}.token.attr-name,code.language-javascript{color:#896724}.language-css .token.string,.language-scss .token.string,.style .token.string,.token.atrule,.token.attr-value,.token.boolean,.token.control,.token.directive,.token.entity,.token.keyword,.token.regex,.token.statement,.token.string,.token.unit,.token.url,code.language-css,code.language-scss{color:#728fcb}.token.placeholder,.token.variable{color:#93abdc}.token.deleted{text-decoration:line-through}.token.inserted{border-bottom:1px dotted #2d2006;text-decoration:none}.token.italic{font-style:italic}.token.bold,.token.important{font-weight:700}.token.important{color:#896724}.token.entity{cursor:help}pre>code.highlight{outline:.4em solid #896724;outline-offset:.4em}.line-numbers.line-numbers .line-numbers-rows{border-right-color:#ece8de}.line-numbers .line-numbers-rows>span:before{color:#cdc4b1}.line-highlight.line-highlight{background:rgba(45,32,6,.2);background:linear-gradient(90deg,rgba(45,32,6,.2) 70%,rgba(45,32,6,0))}}@media screen and (prefers-color-scheme:dark){code[class*=language-],pre[class*=language-]{background:#030314;color:#d6e7ff;direction:ltr;font-family:Consolas,Menlo,Monaco,Andale Mono WT,Andale Mono,Lucida Console,Lucida Sans Typewriter,DejaVu Sans Mono,Bitstream Vera Sans Mono,Liberation Mono,Nimbus Mono L,Courier New,Courier,monospace;font-size:14px;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;line-height:1.375;-moz-tab-size:4;-o-tab-size:4;tab-size:4;text-align:left;white-space:pre;word-break:normal;word-spacing:normal}code[class*=language-]::-moz-selection,code[class*=language-] ::-moz-selection,pre[class*=language-]::-moz-selection,pre[class*=language-] ::-moz-selection{background:#1d3b54;color:inherit;text-shadow:none}code[class*=language-]::-moz-selection,code[class*=language-] ::-moz-selection,code[class*=language-]::selection,code[class*=language-] ::selection,pre[class*=language-]::-moz-selection,pre[class*=language-] ::-moz-selection,pre[class*=language-]::selection,pre[class*=language-] ::selection{background:#1d3b54;color:inherit;text-shadow:none}pre[class*=language-]{border:1px solid #2a4555;border-radius:5px;margin:1em 0;overflow:auto}:not(pre)>code[class*=language-]{background:#2a4555;border-radius:.2em;-webkit-box-decoration-break:clone;box-decoration-break:clone;color:#f0f6f6;padding:.2em .3em}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#446e69}.token.punctuation{color:#d6b007}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#d6e7ff}.token.attr-name,.token.builtin,.token.inserted,.token.selector{color:#e60067}.token.char,.token.string{color:#49c6ec}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url{background:transparent;color:#ec8e01}.token.atrule,.token.attr-value,.token.keyword{color:#0fe468}.token.class-name,.token.function{color:#78f3e9}.token.important,.token.regex,.token.variable{color:#d6e7ff}}.small{font-size:.875rem;line-height:1.25rem}.code{width:100%}pre[class*=language-]{overflow:hidden}.line-highlight:before,.line-highlight[data-end]:after{box-shadow:none}@media (max-width:760px){.small{width:100%}}</style></head>
    
<body>
<article><section><h1>DRIVE II: COMBINE</h1><p class="subtitle"><a href="https://scottorly.github.io">Scott Orlyck</a></p></section><section><img src="https://images.unsplash.com/photo-1565647952915-9644fcd446a4?ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&amp;ixlib=rb-1.2.1&amp;auto=format&amp;fit=crop&amp;w=870&amp;q=80"><blockquote>"We ain't driving tractors here."</blockquote></section><section><p><span class="newthought">In our <a target="_blank" rel="noreferrer noopener" href="https://scottorly.github.io/drive">last episode</a></span>, we implemented some practical iOS UI programming techniques using RxSwift's <a target="_blank" rel="noreferrer noopener" href="https://github.com/ReactiveX/RxSwift/blob/main/Documentation/Traits.md#driver">Driver trait</a> and UIKit. This time we are going to explore some of the same patterns using Apple's reactive programming framework <a target="_blank" rel="noreferrer noopener" href="https://developer.apple.com/documentation/combine">Combine</a>. Implemented with discipline, Rx based architectures can help you avoid smelly anti-patterns like half-cooked spagehetti<label for="1a" class="margin-toggle sidenote-number"></label><input type="checkbox" id="1a" class="margin-toggle"><span class="sidenote">Not enough seperation of concerns.</span> or over-cooked lasgna<label for="2a" class="margin-toggle sidenote-number"></label><input type="checkbox" id="2a" class="margin-toggle"><span class="sidenote">Too much seperation of concerns.</span>, but as with all things it comes with trade-offs.</p><p>One of the biggest problems with Rx architectures is the steep learning curve of not only the reactive language extensions themselves but also learning to reason about the system as a declarative stream of events and data as opposed to imperative statefulness. Lucky for us then that Combine adds some much needed developer ergonomics to reactive extensions that makes things a lot easier when operating on publishers across API boundaries.</p></section><section><h2>THE RETURN OF THE DRIVER</h2><p><label for="1" class="margin-toggle">⊕</label><input type="checkbox" id="1" class="margin-toggle"><span class="marginnote">Find the source code for a project with working examples  <a target="_blank" rel="noreferrer noopener" href="https://github.com/scottorly/drive2combine/tree/main/xcode">here</a>.</span></p><p>If you recall, RxSwift's <a target="_blank" rel="noreferrer noopener" href="https://github.com/ReactiveX/RxSwift/blob/main/Documentation/Traits.md#driver">Driver Trait</a> is a guarantee that the publisher is shared with the last element replayed upon subscription, the subscription is always received on the main thread, and the publisher can never error out. It is instructive to think about Drivers as UI or system events "driving the application".</p><p>One of the main drivers<label for="3a" class="margin-toggle sidenote-number"></label><input type="checkbox" id="3a" class="margin-toggle"><span class="sidenote">I am so sorry.</span> of the RxSwift Driver trait was to help make dealing with type inference across API boundaries less problematic. Combine's convenient <a target="_blank" rel="noreferrer noopener" href="https://developer.apple.com/documentation/combine/just/erasetoanypublisher()">eraseToAnyPublisher</a> API makes this aspect of the driver trait redundant however it is instructive to walk through the implementation with Combine and the result leaves us with some easily re-usable Rx patterns.</p><p>One of the nice things about Combine compared to RxSwift is that the API is much simpler. The primary drawback of this simplicity is that we will need to import CombineExt to provide some operators we need for this architecture pattern to be successful. Nonetheless our code is going to look a lot cleaner thanks to Combine's integration with Foundation. Apple does not provide default publishers for UIKit control events so we will need to add CombineCocoa to our project as well.</p><p>Below are two extensions to Publisher to fulfill our requirements for a Driver. The first demonstrates how to use an <a target="_blank" rel="noreferrer noopener" href="https://developer.apple.com/documentation/combine/empty">Empty</a> publisher to convert a Publisher error type to Never.</p><p><label for="2" class="margin-toggle">⊕</label><input type="checkbox" id="2" class="margin-toggle"><span class="marginnote">Lines 3-4: Some typealias conveniences.<br>Lines 8-9: Catch and return an Empty publisher to convert the error type to Never.<br>Line 11: Share and replay the last element.<br>Line 12: Receive on the main thread.</span></p><figure class="small"><pre data-line="3-4,8-12" class="language-swift" tabindex="0"><code class="code language-swift"><span class="token keyword">import</span> <span class="token class-name">CombineExt</span>
                
<span class="token keyword">typealias</span> <span class="token class-name">Driver</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token class-name">AnyPublisher</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">Never</span><span class="token operator">&gt;</span>
<span class="token keyword">typealias</span> <span class="token class-name">Bag</span> <span class="token operator">=</span> <span class="token class-name">Set</span><span class="token operator">&lt;</span><span class="token class-name">AnyCancellable</span><span class="token operator">&gt;</span>

<span class="token keyword">extension</span> <span class="token class-name">Publisher</span> <span class="token punctuation">{</span>
    <span class="token keyword">func</span> <span class="token function-definition function">driver</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">Driver</span><span class="token operator">&lt;</span><span class="token class-name">Output</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        `<span class="token keyword">catch</span>` <span class="token punctuation">{</span> error <span class="token operator">-&gt;</span> <span class="token class-name">AnyPublisher</span><span class="token operator">&lt;</span><span class="token class-name">Output</span><span class="token punctuation">,</span> <span class="token class-name">Never</span><span class="token operator">&gt;</span> <span class="token keyword">in</span>
            <span class="token class-name">Empty</span><span class="token punctuation">(</span>completeImmediately<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eraseToAnyPublisher</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token function">share</span><span class="token punctuation">(</span>replay<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">receive</span><span class="token punctuation">(</span>on<span class="token punctuation">:</span> <span class="token class-name">RunLoop</span><span class="token punctuation">.</span>main<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">eraseToAnyPublisher</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><div aria-hidden="true" data-range="3-4" class="line-highlight" data-start="3" data-end="4" style="top: 38px; width: 385px;"> 
 
</div><div aria-hidden="true" data-range="8-12" class="line-highlight" data-start="8" data-end="12" style="top: 133px; width: 385px;"> 
 
 
 
 
</div></code></pre></figure><p><label for="3" class="margin-toggle">⊕</label><input type="checkbox" id="3" class="margin-toggle"><span class="marginnote">If it makes more sense to provide a default value to the driver function wrap the default value parameter in a Just publisher instead of returning an Empty publisher.</span></p><figure class="small"><pre data-line="3" class="language-swift" tabindex="0"><code class="code language-swift"><span class="token keyword">func</span> <span class="token function-definition function">driver</span><span class="token punctuation">(</span>onErrorJustReturn<span class="token punctuation">:</span> <span class="token class-name">Output</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">Driver</span><span class="token operator">&lt;</span><span class="token class-name">Output</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    `<span class="token keyword">catch</span>` <span class="token punctuation">{</span> error <span class="token operator">-&gt;</span> <span class="token class-name">Just</span><span class="token operator">&lt;</span><span class="token class-name">Output</span><span class="token operator">&gt;</span> <span class="token keyword">in</span>
        <span class="token class-name">Just</span><span class="token punctuation">(</span>onErrorJustReturn<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token function">share</span><span class="token punctuation">(</span>replay<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">receive</span><span class="token punctuation">(</span>on<span class="token punctuation">:</span> <span class="token class-name">RunLoop</span><span class="token punctuation">.</span>main<span class="token punctuation">,</span> options<span class="token punctuation">:</span> <span class="token nil constant">nil</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">eraseToAnyPublisher</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><div aria-hidden="true" data-range="3" class="line-highlight" data-start="3" style="top: 38px; width: 385px;"> 
</div></code></pre></figure><p><label for="4" class="margin-toggle">⊕</label><input type="checkbox" id="4" class="margin-toggle"><span class="marginnote">One more extension for our UITextfield publisher so we don't have to worry about unwrapping optionals anywhere along our publisher chain.</span></p><figure class="small"><pre data-line="3" class="language-swift" tabindex="0"><code class="code language-swift"><span class="token keyword">extension</span> <span class="token class-name">UITextField</span> <span class="token punctuation">{</span>
    <span class="token keyword">func</span> <span class="token function-definition function">textDriver</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">Driver</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        textPublisher<span class="token punctuation">.</span><span class="token function">replaceNil</span><span class="token punctuation">(</span>with<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">""</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">driver</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><div aria-hidden="true" data-range="3" class="line-highlight" data-start="3" style="top: 38px; width: 385px;"> 
</div></code></pre></figure></section><section><h2>MVVM + VC</h2><p>We can't accurately call this pattern MVVM becuase it's more like Model-View-ViewModel-ViewController. The ViewController is responsible for connecting the ViewModel to the Views as well as managing the navigation stack which is exactly what UIViewControllers are supposed to do!</p><p>Take a look at the ViewModel implementation below as now is a good time to review some rules<label for="4a" class="margin-toggle sidenote-number"></label><input type="checkbox" id="4a" class="margin-toggle"><span class="sidenote">The ViewModel cannot import UIKit and will never subscribe to any publishers.</span> to help enforce seperation of concerns and prevent side effects.</p><p><label for="5" class="margin-toggle">⊕</label><input type="checkbox" id="5" class="margin-toggle"><span class="marginnote"><br></span></p><figure class="small"><pre data-line="" class="language-swift" tabindex="0"><code class="code language-swift"><span class="token keyword">import</span> <span class="token class-name">Combine</span>
<span class="token keyword">import</span> <span class="token class-name">CombineExt</span>

<span class="token keyword">class</span> <span class="token class-name">ViewModel</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">let</span> validatedUsername<span class="token punctuation">:</span> <span class="token class-name">Driver</span><span class="token operator">&lt;</span><span class="token class-name">Validation</span><span class="token operator">&gt;</span>
    <span class="token keyword">let</span> validatedPassword<span class="token punctuation">:</span> <span class="token class-name">Driver</span><span class="token operator">&lt;</span><span class="token class-name">Validation</span><span class="token operator">&gt;</span>
    <span class="token keyword">let</span> enabled<span class="token punctuation">:</span> <span class="token class-name">Driver</span><span class="token operator">&lt;</span><span class="token class-name">Bool</span><span class="token operator">&gt;</span>
    <span class="token keyword">let</span> loggedIn<span class="token punctuation">:</span> <span class="token class-name">Driver</span><span class="token operator">&lt;</span><span class="token class-name">Response</span><span class="token operator">&gt;</span>
</code></pre></figure><p>We initialize the ViewModel with out IBOutlet driver parameters.</p><p><label for="6" class="margin-toggle">⊕</label><input type="checkbox" id="6" class="margin-toggle"><span class="marginnote"><br></span></p><figure class="small"><pre data-line="1,6,10" class="language-swift" tabindex="0"><code class="code language-swift"><span class="token keyword">init</span><span class="token punctuation">(</span>
    username<span class="token punctuation">:</span> <span class="token class-name">Driver</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    password<span class="token punctuation">:</span> <span class="token class-name">Driver</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    login<span class="token punctuation">:</span> <span class="token class-name">AnyPublisher</span><span class="token operator">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">,</span> <span class="token class-name">Never</span><span class="token operator">&gt;</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    validatedUsername <span class="token operator">=</span> username<span class="token punctuation">.</span>flatMapLatest <span class="token punctuation">{</span>
        <span class="token class-name">Validator</span><span class="token punctuation">.</span>shared<span class="token punctuation">.</span><span class="token function">username</span><span class="token punctuation">(</span>username<span class="token punctuation">:</span> <span class="token short-argument">$0</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">driver</span><span class="token punctuation">(</span>onErrorJustReturn<span class="token punctuation">:</span> <span class="token punctuation">.</span><span class="token function">failed</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"Invalid username."</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    validatedPassword <span class="token operator">=</span> password<span class="token punctuation">.</span>flatMapLatest <span class="token punctuation">{</span>
        <span class="token class-name">Validator</span><span class="token punctuation">.</span>shared<span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span>password<span class="token punctuation">:</span> <span class="token short-argument">$0</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">driver</span><span class="token punctuation">(</span>onErrorJustReturn<span class="token punctuation">:</span> <span class="token punctuation">.</span><span class="token function">failed</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"Invalid password"</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<div aria-hidden="true" data-range="1" class="line-highlight" data-start="1" style="top: 0px; width: 385px;"> 
</div><div aria-hidden="true" data-range="6" class="line-highlight" data-start="6" style="top: 95px; width: 385px;"> 
</div><div aria-hidden="true" data-range="10" class="line-highlight" data-start="10" style="top: 171px; width: 385px;"> 
</div></code></pre></figure><p></p><p><label for="7" class="margin-toggle">⊕</label><input type="checkbox" id="7" class="margin-toggle"><span class="marginnote"><br></span></p><figure class="small"><pre data-line="1,6,14,20" class="language-swift" tabindex="0"><code class="code language-swift">    <span class="token keyword">let</span> combined <span class="token operator">=</span> <span class="token class-name">Publishers</span><span class="token punctuation">.</span><span class="token class-name">CombineLatest</span><span class="token punctuation">(</span>
        validatedUsername<span class="token punctuation">,</span>
        validatedPassword
    <span class="token punctuation">)</span>

    enabled <span class="token operator">=</span> combined
        <span class="token punctuation">.</span>flatMapLatest <span class="token punctuation">{</span> username<span class="token punctuation">,</span> password <span class="token operator">-&gt;</span> <span class="token class-name">Just</span><span class="token operator">&lt;</span><span class="token class-name">Bool</span><span class="token operator">&gt;</span> <span class="token keyword">in</span>
            <span class="token keyword">if</span> <span class="token keyword">case</span> <span class="token punctuation">(</span><span class="token punctuation">.</span>success<span class="token punctuation">,</span> <span class="token punctuation">.</span>success<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span>username<span class="token punctuation">,</span> password<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token class-name">Just</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token class-name">Just</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">driver</span><span class="token punctuation">(</span>onErrorJustReturn<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">)</span>

    <span class="token keyword">let</span> combinedCredentials <span class="token operator">=</span> <span class="token class-name">Publishers</span>
        <span class="token punctuation">.</span><span class="token class-name">CombineLatest</span><span class="token punctuation">(</span>
            username<span class="token punctuation">,</span>
            password
        <span class="token punctuation">)</span>

    loggedIn <span class="token operator">=</span> login<span class="token punctuation">.</span><span class="token function">withLatestFrom</span><span class="token punctuation">(</span>combinedCredentials<span class="token punctuation">)</span>
        <span class="token punctuation">.</span>flatMapLatest <span class="token punctuation">{</span>
            <span class="token class-name">Network</span><span class="token punctuation">.</span>shared<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span>username<span class="token punctuation">:</span> <span class="token short-argument">$0</span><span class="token punctuation">,</span> password<span class="token punctuation">:</span> <span class="token short-argument">$1</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">driver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><div aria-hidden="true" data-range="1" class="line-highlight" data-start="1" style="top: 0px; width: 385px;"> 
</div><div aria-hidden="true" data-range="6" class="line-highlight" data-start="6" style="top: 95px; width: 385px;"> 
</div><div aria-hidden="true" data-range="14" class="line-highlight" data-start="14" style="top: 247px; width: 385px;"> 
</div><div aria-hidden="true" data-range="20" class="line-highlight" data-start="20" style="top: 361px; width: 385px;"> 
</div></code></pre></figure><p>The ViewModel isn't too much different than last time except now it is significantly simpler. Define the outputs, connect the inputs and subscribe in the ViewController. Bish bash bosh, next thing you know, Robert's your father's brother.</p><p>One thing we wont be implementing here is the drive function itself which serves as a type erased replacement for subscribe in RxSwift. Combine's built-in type erasure has already made our API boundaries tidy and easy to work with.</p><p><label for="8" class="margin-toggle">⊕</label><input type="checkbox" id="8" class="margin-toggle"><span class="marginnote"> </span></p><figure class="small"><pre data-line="5,6,7,9,11" class="language-swift" tabindex="0"><code class="code language-swift"><span class="token keyword">import</span> <span class="token class-name">CombineCocoa</span>

<span class="token keyword">class</span> <span class="token class-name">ViewController</span><span class="token punctuation">:</span> <span class="token class-name">UIViewController</span> <span class="token punctuation">{</span>
    
    <span class="token attribute atrule">@IBOutlet</span> <span class="token keyword">weak</span> <span class="token keyword">var</span> username<span class="token punctuation">:</span> <span class="token class-name">UITextField</span><span class="token operator">!</span>
    <span class="token attribute atrule">@IBOutlet</span> <span class="token keyword">weak</span> <span class="token keyword">var</span> password<span class="token punctuation">:</span> <span class="token class-name">UITextField</span><span class="token operator">!</span>
    <span class="token attribute atrule">@IBOutlet</span> <span class="token keyword">weak</span> <span class="token keyword">var</span> login<span class="token punctuation">:</span> <span class="token class-name">UIButton</span><span class="token operator">!</span>

    <span class="token keyword">var</span> bag <span class="token operator">=</span> <span class="token class-name">Bag</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">lazy</span> <span class="token keyword">var</span> viewModel<span class="token punctuation">:</span> <span class="token class-name">ViewModel</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token class-name">ViewModel</span><span class="token punctuation">(</span>
            username<span class="token punctuation">:</span> username<span class="token punctuation">.</span><span class="token function">textDriver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            password<span class="token punctuation">:</span> password<span class="token punctuation">.</span><span class="token function">textDriver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            login<span class="token punctuation">:</span> login<span class="token punctuation">.</span>tapPublisher<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token punctuation">}</span><div aria-hidden="true" data-range="5" class="line-highlight" data-start="5" style="top: 76px; width: 385px;"> 
</div><div aria-hidden="true" data-range="6" class="line-highlight" data-start="6" style="top: 95px; width: 385px;"> 
</div><div aria-hidden="true" data-range="7" class="line-highlight" data-start="7" style="top: 114px; width: 385px;"> 
</div><div aria-hidden="true" data-range="9" class="line-highlight" data-start="9" style="top: 152px; width: 385px;"> 
</div><div aria-hidden="true" data-range="11" class="line-highlight" data-start="11" style="top: 190px; width: 385px;"> 
</div></code></pre></figure><p>Back in our ViewController we can start to connect the ViewModel outputs to the Views.</p><p><label for="9" class="margin-toggle">⊕</label><input type="checkbox" id="9" class="margin-toggle"><span class="marginnote">Since the ViewModel outputs are all Drivers we can rest assured that our subscriptions will be received on the main thread.</span></p><figure class="small"><pre data-line="" class="language-swift" tabindex="0"><code class="code language-swift">viewModel<span class="token punctuation">.</span>validatedUsername
    <span class="token punctuation">.</span>sink <span class="token punctuation">{</span> <span class="token punctuation">[</span><span class="token keyword">weak</span> <span class="token keyword">self</span><span class="token punctuation">]</span> validation <span class="token keyword">in</span>
        <span class="token keyword">if</span> <span class="token keyword">case</span> <span class="token punctuation">.</span><span class="token function">failed</span><span class="token punctuation">(</span><span class="token keyword">let</span> message<span class="token punctuation">)</span> <span class="token operator">=</span> validation <span class="token punctuation">{</span>
            <span class="token keyword">self</span><span class="token operator">?</span><span class="token punctuation">.</span>usernameError<span class="token punctuation">.</span>text <span class="token operator">=</span> message
            <span class="token keyword">self</span><span class="token operator">?</span><span class="token punctuation">.</span>usernameError<span class="token punctuation">.</span>isHidden <span class="token operator">=</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">self</span><span class="token operator">?</span><span class="token punctuation">.</span>usernameError<span class="token punctuation">.</span>isHidden <span class="token operator">=</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token keyword">in</span><span class="token punctuation">:</span> <span class="token operator">&amp;</span>bag<span class="token punctuation">)</span>

    viewModel<span class="token punctuation">.</span>validatedPassword
        <span class="token punctuation">.</span>sink <span class="token punctuation">{</span> <span class="token punctuation">[</span><span class="token keyword">weak</span> <span class="token keyword">self</span><span class="token punctuation">]</span> validation <span class="token keyword">in</span>
            <span class="token keyword">if</span> <span class="token keyword">case</span> <span class="token punctuation">.</span><span class="token function">failed</span><span class="token punctuation">(</span><span class="token keyword">let</span> message<span class="token punctuation">)</span> <span class="token operator">=</span> validation <span class="token punctuation">{</span>
                <span class="token keyword">self</span><span class="token operator">?</span><span class="token punctuation">.</span>passwordError<span class="token punctuation">.</span>text <span class="token operator">=</span> message
                <span class="token keyword">self</span><span class="token operator">?</span><span class="token punctuation">.</span>passwordError<span class="token punctuation">.</span>isHidden <span class="token operator">=</span> <span class="token boolean">false</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">self</span><span class="token operator">?</span><span class="token punctuation">.</span>passwordError<span class="token punctuation">.</span>isHidden <span class="token operator">=</span> <span class="token boolean">true</span>
            <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token keyword">in</span><span class="token punctuation">:</span> <span class="token operator">&amp;</span>bag<span class="token punctuation">)</span></code></pre></figure><p>Now we can connect the login button enabled state and the request result outlets.</p><p><label for="10" class="margin-toggle">⊕</label><input type="checkbox" id="10" class="margin-toggle"><span class="marginnote">As always, don't forget to use weak self, put the subscriptions in the bag, and call your bind function in viewDidLoad.</span></p><figure class="small"><pre class="language-swift" tabindex="0"><code class="code language-swift">viewModel<span class="token punctuation">.</span>enabled<span class="token punctuation">.</span>sink <span class="token punctuation">{</span> <span class="token punctuation">[</span><span class="token keyword">weak</span> <span class="token keyword">self</span><span class="token punctuation">]</span> enabled <span class="token keyword">in</span>
    <span class="token keyword">self</span><span class="token operator">?</span><span class="token punctuation">.</span>login<span class="token punctuation">.</span>isEnabled <span class="token operator">=</span> enabled
<span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token keyword">in</span><span class="token punctuation">:</span> <span class="token operator">&amp;</span>bag<span class="token punctuation">)</span>

viewModel<span class="token punctuation">.</span>loggedIn<span class="token punctuation">.</span>sink <span class="token punctuation">{</span> <span class="token punctuation">[</span><span class="token keyword">weak</span> <span class="token keyword">self</span><span class="token punctuation">]</span> response <span class="token keyword">in</span>
    <span class="token keyword">if</span> <span class="token keyword">case</span> <span class="token punctuation">.</span>success <span class="token operator">=</span> response <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">performSegue</span><span class="token punctuation">(</span>withIdentifier<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"LOGGEDIN"</span></span><span class="token punctuation">,</span> sender<span class="token punctuation">:</span> <span class="token nil constant">nil</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token keyword">in</span><span class="token punctuation">:</span> <span class="token operator">&amp;</span>bag<span class="token punctuation">)</span></code></pre></figure></section><section><h2>IN THE BAG</h2><p>Until next time ;)</p></section><section><h3>Acknowledgements</h3><p>Styles by <a target="_blank" rel="noreferrer noopener" href="https://edwardtufte.github.io/tufte-css/">Tufte-CSS</a>.</p><p>Syntax by <a target="_blank" rel="noreferrer noopener" href="https://prismjs.com/">PrismJS</a></p></section><footer><em>Copyright © 2021 Scott Orlyck. All rights reserved.</em></footer></article></body></html>